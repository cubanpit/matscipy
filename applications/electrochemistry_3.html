<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Steric correction &mdash; matscipy devel documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=1dba82e2"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tribology" href="tribology.html" />
    <link rel="prev" title="Poisson-Nernst-Planck systems by finite element method" href="electrochemistry_2.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            matscipy
          </a>
              <div class="version">
                devel
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">matscipy</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Application domains</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="elastic_constants.html">Elastic Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="plasticity.html">Plasticity</a></li>
<li class="toctree-l2"><a class="reference internal" href="fracture_mechanics.html">Fracture Mechanics</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="electrochemistry.html">Electrochemistry</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="electrochemistry_1.html">One-dimensional Poisson-Nernst-Planck systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="electrochemistry_1.html#from-continuous-double-layer-theory-to-discrete-coordinate-sets">From continuous double layer theory to discrete coordinate sets</a></li>
<li class="toctree-l3"><a class="reference internal" href="electrochemistry_2.html">Poisson-Nernst-Planck systems by finite element method</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Steric correction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#step-1-generating-continuous-concentration-distributions">Step 1: generating continuous concentration distributions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-2-sampling-from-distributions">Step 2: sampling from distributions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-3-enforcing-steric-radii">Step 3: enforcing steric radii</a></li>
<li class="toctree-l4"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="electrochemistry.html#acknowledgements">Acknowledgements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tribology.html">Tribology</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Analysis tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../calculators/index.html">Interatomic potentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topology/index.html">Structure and topology generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">matscipy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Application domains</a></li>
          <li class="breadcrumb-item"><a href="electrochemistry.html">Electrochemistry</a></li>
      <li class="breadcrumb-item active">Steric correction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/applications/electrochemistry_3.py.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="steric-correction">
<h1>Steric correction<a class="headerlink" href="#steric-correction" title="Link to this heading"></a></h1>
<p>Continuum models do not account for the finite size of atoms. Sampling discrete particle coordinates from continuous concentration distributions may thus result in arbitrarily close atom positions. To avoid overlap and yield <em>usable</em> atomistic configurations from densely packed samples, <code class="docutils literal notranslate"><span class="pre">matscipy.electrochemistry</span></code> offers the <code class="docutils literal notranslate"><span class="pre">steric_correction</span></code> sub-module. Its function <code class="docutils literal notranslate"><span class="pre">apply_steric_correction</span></code> applies a steric correction to the provided configuration, assuring the desired steric radii for all species if possible. To achieve this, the module re-implements a pseudo-potential minimization algorithm <a class="reference internal" href="#martinez2009"><span class="xref myst">[1]</span></a> used by <a class="reference external" href="https://m3g.github.io/packmol/">PACKMOL</a> in Python</p>
<p>Below, we generate continuous concentration distributions from classical electrochemical double layer theory, sample coordinates from these distributions, and apply a steric correction to the ion coordinates.</p>
<p>Theory and mechanisms involved in step 1 and 2 have been discussed in detail in previous documentation sections.</p>
<section id="step-1-generating-continuous-concentration-distributions">
<h2>Step 1: generating continuous concentration distributions<a class="headerlink" href="#step-1-generating-continuous-concentration-distributions" title="Link to this heading"></a></h2>
<p>Adjacent to an inert electrode at an open half-space, concentration distributions of a binary electrolyte are retrieved from the analytical solution of the Poisson-Boltzmann equation. <code class="docutils literal notranslate"><span class="pre">matscipy.electrochemistry.poisson_boltzmann_distribution</span></code> provides a simple interface to this analytical solution. Let’s consider 1 mM saline solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matscipy.electrochemistry.poisson_boltzmann_distribution</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">potential</span><span class="p">,</span> <span class="n">concentration</span><span class="p">,</span> <span class="n">charge_density</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/lib/python3/dist-packages/scipy/__init__.py:146: UserWarning: A NumPy version &gt;=1.17.3 and &lt;1.25.0 is required for this version of SciPy (detected version 1.26.3
  warnings.warn(f&quot;A NumPy version &gt;={np_minversion} and &lt;{np_maxversion}&quot;
</pre></div>
</div>
</div>
</div>
<p>Although we look at a continuous 1d system now, we want to sample coordinates in a 3d box from it later. Hence, we specify the 3d box size here already and retrieve potential, concentration and charge distributions arising from solving the Poisson-Boltzmann equation analytically.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 

<span class="c1"># measures of box</span>
<span class="n">xsize</span> <span class="o">=</span> <span class="n">ysize</span> <span class="o">=</span> <span class="mf">5e-9</span> <span class="c1"># nm, SI units</span>
<span class="n">zsize</span> <span class="o">=</span> <span class="mf">20e-9</span>        <span class="c1"># nm, SI units</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">zsize</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>   <span class="c1"># bulk concentrations of Na and Cl, mM, SI units</span>
<span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># number charges of species</span>
<span class="n">u</span> <span class="o">=</span> <span class="mf">0.05</span>     <span class="c1"># electrostatic potential across the interface, V</span>

<span class="n">phi</span> <span class="o">=</span> <span class="n">potential</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
<span class="n">C</span>   <span class="o">=</span> <span class="n">concentration</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">charge_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we visualize these distributions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.constants</span> <span class="k">as</span> <span class="nn">sc</span>    <span class="c1"># fundamental constants</span>

<span class="kn">from</span> <span class="nn">matscipy.electrochemistry</span> <span class="kn">import</span> <span class="n">debye</span>

<span class="k">def</span> <span class="nf">make_patch_spines_invisible</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        

<span class="n">deb</span> <span class="o">=</span> <span class="n">debye</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 

<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;distance x (nm)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">nano</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;potential&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;potential $\phi$ (V)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">deb</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">nano</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Debye Length&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">nano</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;bulk concentration of Na+ ions&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">nano</span><span class="p">,</span> <span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Na+ ions&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">nano</span><span class="p">,</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Cl- ions&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;concentration c (mM)&#39;</span><span class="p">)</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="c1"># Offset the right spine of par2.  The ticks and label have already been</span>
<span class="c1"># placed on the right by twinx above.</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s2">&quot;axes&quot;</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">))</span>
<span class="c1"># Having been created by twinx, par2 has its frame off, so the line of its</span>
<span class="c1"># detached spine is invisible.  First, activate the frame but make the patch</span>
<span class="c1"># and spines invisible.</span>
<span class="n">make_patch_spines_invisible</span><span class="p">(</span><span class="n">ax3</span><span class="p">)</span>
<span class="c1"># Second, show the right spine.</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">nano</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;charge density&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;charge density $\rho \&gt; (\mathrm</span><span class="si">{C}</span><span class="s1">\&gt; \mathrm</span><span class="si">{m}</span><span class="s1">^{-3})$&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9d363ecb239d8adf26d0423ee222bb5d167bf848aacdb54dcabd420ba71223f7.png" src="../_images/9d363ecb239d8adf26d0423ee222bb5d167bf848aacdb54dcabd420ba71223f7.png" />
</div>
</div>
</section>
<section id="step-2-sampling-from-distributions">
<h2>Step 2: sampling from distributions<a class="headerlink" href="#step-2-sampling-from-distributions" title="Link to this heading"></a></h2>
<p>We sample and visualize discrete coordinate sets from our continuous distributions as before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">matscipy.electrochemistry</span> <span class="kn">import</span> <span class="n">continuous2discrete</span>
<span class="kn">from</span> <span class="nn">matscipy.electrochemistry</span> <span class="kn">import</span> <span class="n">get_histogram</span>

<span class="c1"># helper functions</span>
<span class="k">def</span> <span class="nf">get_centers</span><span class="p">(</span><span class="n">bins</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the center of the provided bins.</span>

<span class="sd">    Example:</span>
<span class="sd">    &gt;&gt;&gt; get_centers(bins=np.array([0.0, 1.0, 2.0]))</span>
<span class="sd">    array([ 0.5,  1.5])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">plot_dist</span><span class="p">(</span><span class="n">histogram</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">reference_distribution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot histogram with an optional reference distribution.&quot;&quot;&quot;</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">histogram</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">get_centers</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        
    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span> <span class="n">centers</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Empirical distribution&#39;</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reference_distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">reference_distribution</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span>
        <span class="n">ref</span> <span class="o">/=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Target distribution&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance&#39;</span><span class="p">)</span>

<span class="c1"># create distribution functions</span>
<span class="n">distributions</span> <span class="o">=</span> <span class="p">[</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span>

<span class="c1"># sample discrete coordinate set</span>
<span class="n">box3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">])</span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="mi">200</span>

<span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">continuous2discrete</span><span class="p">(</span><span class="n">distribution</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box3</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">distributions</span><span class="p">]</span>
<span class="n">species</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Na+&#39;</span><span class="p">,</span><span class="s1">&#39;Cl-&#39;</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
<span class="k">for</span> <span class="n">ion</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ax_row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">distributions</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
    <span class="n">histx</span><span class="p">,</span> <span class="n">histy</span><span class="p">,</span> <span class="n">histz</span> <span class="o">=</span> <span class="n">get_histogram</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box3</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">51</span><span class="p">)</span>
    <span class="n">plot_dist</span><span class="p">(</span><span class="n">histx</span><span class="p">,</span> <span class="s1">&#39;Distribution of </span><span class="si">{:s}</span><span class="s1"> ions in x-direction&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ion</span><span class="p">),</span> 
              <span class="n">reference_distribution</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="n">box3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plot_dist</span><span class="p">(</span><span class="n">histy</span><span class="p">,</span> <span class="s1">&#39;Distribution of </span><span class="si">{:s}</span><span class="s1"> ions in y-direction&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ion</span><span class="p">),</span> 
              <span class="n">reference_distribution</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="n">box3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plot_dist</span><span class="p">(</span><span class="n">histz</span><span class="p">,</span> <span class="s1">&#39;Distribution of </span><span class="si">{:s}</span><span class="s1"> ions in z-direction&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ion</span><span class="p">),</span> 
              <span class="n">reference_distribution</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f7e67f7ba90b90054768ebdaa07f135acbdab293da217e6bd4bd537c51ad8a77.png" src="../_images/f7e67f7ba90b90054768ebdaa07f135acbdab293da217e6bd4bd537c51ad8a77.png" />
</div>
</div>
</section>
<section id="step-3-enforcing-steric-radii">
<h2>Step 3: enforcing steric radii<a class="headerlink" href="#step-3-enforcing-steric-radii" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">matscipy.electrochemistry.steric_correction</span></code> exposes a few functions for finding the closest pair within a coordinate set. We use <code class="docutils literal notranslate"><span class="pre">scipy_distance_based_closest_pair</span></code> to inspect our coordinates in their initial state:</p>
<section id="inspect-the-initial-coordinate-sample">
<h3>Inspect the initial coordinate sample<a class="headerlink" href="#inspect-the-initial-coordinate-sample" title="Link to this heading"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matscipy.electrochemistry.steric_correction</span> <span class="kn">import</span> <span class="n">scipy_distance_based_closest_pair</span>

<span class="c1"># need all coordinates in one N x 3 array</span>
<span class="n">xstacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

<span class="n">box6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">box3</span><span class="p">])</span> <span class="c1"># needs lower corner</span>

<span class="n">mindsq</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="o">=</span> <span class="n">scipy_distance_based_closest_pair</span><span class="p">(</span><span class="n">xstacked</span><span class="p">)</span>
<span class="n">pmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xstacked</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xstacked</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mindsq</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum pair-wise distance in sample: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mind</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First sample point in pair:    (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Second sample point in pair    (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">p2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Box lower boundary:            (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">box6</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum coordinates in sample: (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">pmin</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum coordinates in sample: (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">pmax</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Box upper boundary:            (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">box6</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Minimum pair-wise distance in sample: 1.352188695855715e-10
First sample point in pair:    (4.4566e-09,3.7113e-09,1.3501e-08)
Second sample point in pair    (4.3269e-09,3.6958e-09,1.3537e-08)
Box lower boundary:            (0.0000e+00,0.0000e+00,0.0000e+00)
Minimum coordinates in sample: (2.3292e-12,6.1885e-13,2.2696e-11)
Maximum coordinates in sample: (4.9992e-09,4.9942e-09,1.9953e-08)
Box upper boundary:            (5.0000e-09,5.0000e-09,2.0000e-08)
</pre></div>
</div>
</div>
</div>
<p>The distance between the closest pair of ions will be at the order of an Ångström.</p>
</section>
<section id="apply-the-steric-correction">
<h3>Apply the steric correction<a class="headerlink" href="#apply-the-steric-correction" title="Link to this heading"></a></h3>
<p>Next, we use <code class="docutils literal notranslate"><span class="pre">apply_steric_correction</span></code> to ensure a radius of 2 Å on all our ions. If no other method specified, then <code class="docutils literal notranslate"><span class="pre">apply_steric_correction</span></code> uses scipy’s L-BFGS-B minimizer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matscipy.electrochemistry.steric_correction</span> <span class="kn">import</span> <span class="n">apply_steric_correction</span>

<span class="n">r</span> <span class="o">=</span> <span class="mf">2e-10</span> <span class="c1"># 2 Angstrom steric radius</span>

<span class="n">x1</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">apply_steric_correction</span><span class="p">(</span><span class="n">xstacked</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box6</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_8705/3409156327.py:5: DeprecationWarning: `product` is deprecated as of NumPy 1.25.0, and will be removed in NumPy 2.0. Please use `prod` instead.
  x1, res = apply_steric_correction(xstacked, box=box6, r=r, options={&#39;disp&#39;: False})
</pre></div>
</div>
</div>
</div>
<p>We inspect the results. The minimal pair distance comes close enough to 4 Å now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mindsq</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="o">=</span> <span class="n">scipy_distance_based_closest_pair</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
<span class="n">mind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mindsq</span><span class="p">)</span>
<span class="n">pmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scipy-interfaced L-BFGS-B minimizer finished with&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    status = </span><span class="si">{}</span><span class="s2">, success = </span><span class="si">{}</span><span class="s2">, #it = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">nit</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    message = &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum pair-wise distance in final configuration: </span><span class="si">{:8.4e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mind</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First sample point in pair:    (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Second sample point in pair    (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">p2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Box lower boundary:            (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">box6</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum coordinates in sample: (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">pmin</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum coordinates in sample: (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">pmax</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Box upper boundary:            (</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">,</span><span class="si">{:8.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">box6</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>scipy-interfaced L-BFGS-B minimizer finished with
    status = 0, success = True, #it = 9
    message = &#39;CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL&#39;

Minimum pair-wise distance in final configuration: 3.9730e-10
First sample point in pair:    (7.2318e-10,3.7182e-10,9.2865e-09)
Second sample point in pair    (9.4771e-10,2.8167e-10,9.6017e-09)
Box lower boundary:            (0.0000e+00,0.0000e+00,0.0000e+00)
Minimum coordinates in sample: (2.0979e-10,2.0107e-10,2.2803e-10)
Maximum coordinates in sample: (4.7982e-09,4.7956e-09,1.9780e-08)
Box upper boundary:            (5.0000e-09,5.0000e-09,2.0000e-08)
</pre></div>
</div>
</div>
</div>
<p>Out of 400 positions, that many have been shifted:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check difference between initial and final configuration</span>
<span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">xstacked</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="c1"># that many coordinates modified</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>353
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check difference between initial and final configuration</span>
<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xstacked</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="c1"># euclidean distance between two sets</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.96192377352509e-09
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-the-applied-corrections">
<h3>Visualize the applied corrections<a class="headerlink" href="#visualize-the-applied-corrections" title="Link to this heading"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pick last result and split by species</span>
<span class="n">steric_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">x1</span><span class="p">[:</span><span class="n">sample_size</span><span class="p">,:],</span> <span class="n">x1</span><span class="p">[</span><span class="n">sample_size</span><span class="p">:,:]]</span>

<span class="c1"># Distribution of corrections</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>

<span class="n">n_bins</span> <span class="o">=</span> <span class="mi">101</span>
<span class="k">for</span> <span class="n">ion</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">steric_sample</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ax_row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">steric_samples</span><span class="p">,</span> <span class="n">distributions</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>

    <span class="n">hists</span> <span class="o">=</span> <span class="n">get_histogram</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box3</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">)</span>    
    <span class="n">steric_hists</span> <span class="o">=</span> <span class="n">get_histogram</span><span class="p">(</span><span class="n">steric_sample</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box3</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">)</span>    
    
    <span class="c1"># first entry is counts, second entry is bins</span>
    <span class="n">diff_hists</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">hs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hists</span><span class="p">,</span> <span class="n">steric_hists</span><span class="p">)]</span>
    
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">ax_col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">diff_hists</span><span class="p">,</span> <span class="n">ax_row</span><span class="p">):</span>
        <span class="n">plot_dist</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Difference from non-steric to steric </span><span class="si">{:s}</span><span class="s1"> ion sample in </span><span class="si">{:s}</span><span class="s1">-direction&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ion</span><span class="p">,</span> <span class="n">ax</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_col</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5858cba30fe79b3e8a29d06890849178290ffdcb15a3ea80c3946308c16b0f70.png" src="../_images/5858cba30fe79b3e8a29d06890849178290ffdcb15a3ea80c3946308c16b0f70.png" />
</div>
</div>
</section>
<section id="export-initial-and-steric-configurations">
<h3>Export initial and steric configurations<a class="headerlink" href="#export-initial-and-steric-configurations" title="Link to this heading"></a></h3>
<p>We may use ASE to export both initial and steric coordinate samples to LAMMPS data files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ase</span>
<span class="kn">import</span> <span class="nn">ase.io</span>

<span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">(</span>
    <span class="n">cell</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">box3</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">angstrom</span><span class="p">),</span>
    <span class="n">pbc</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span> 

<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">charge</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="n">system</span> <span class="o">+=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">(</span>
        <span class="n">symbols</span><span class="o">=</span><span class="n">symbol</span><span class="o">*</span><span class="n">sample_size</span><span class="p">,</span>
        <span class="n">charges</span><span class="o">=</span><span class="p">[</span><span class="n">charge</span><span class="p">]</span><span class="o">*</span><span class="n">sample_size</span><span class="p">,</span>
        <span class="n">positions</span><span class="o">=</span><span class="n">sample</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>

<span class="n">steric_system</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">(</span>
    <span class="n">cell</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">box3</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">angstrom</span><span class="p">),</span>
    <span class="n">pbc</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span> 

<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">charge</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">steric_samples</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="n">steric_system</span> <span class="o">+=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">(</span>
        <span class="n">symbols</span><span class="o">=</span><span class="n">symbol</span><span class="o">*</span><span class="n">sample_size</span><span class="p">,</span>
        <span class="n">charges</span><span class="o">=</span><span class="p">[</span><span class="n">charge</span><span class="p">]</span><span class="o">*</span><span class="n">sample_size</span><span class="p">,</span>
        <span class="n">positions</span><span class="o">=</span><span class="n">sample</span><span class="o">/</span><span class="n">sc</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>

<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NaCl_200_0.05V_5x5x20nm_at_interface_pb_distributed.lammps&#39;</span><span class="p">,</span>
             <span class="n">system</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;lammps-data&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="n">atom_style</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NaCl_200_0.05V_5x5x20nm_at_interface_pb_distributed_steric_correction_2Ang.lammps&#39;</span><span class="p">,</span>
             <span class="n">steric_system</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;lammps-data&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="n">atom_style</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The following visualization of the applied coordinate shifts has been created by showing displacement vectors between non-steric and steric sample with Ovito:</p>
<p><img alt="Steric correction on 200 NaCl" src="../_images/steric_correction_on_200_NaCl_300px.png" /></p>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading"></a></h2>
<p><a id='martinez2009'></a>[1] L. Martinez, R. Andrade, E. G. Birgin, and J. M. Martínez, “PACKMOL: A package for building initial configurations for molecular dynamics simulations,” J. Comput. Chem., vol. 30, no. 13, pp. 2157–2164, 2009, doi: <a class="reference external" href="https://doi.org/10.1002/jcc.21224">10.1002/jcc.21224</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="electrochemistry_2.html" class="btn btn-neutral float-left" title="Poisson-Nernst-Planck systems by finite element method" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tribology.html" class="btn btn-neutral float-right" title="Tribology" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, James Kermode, Lars Pastewka, et al.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>